#!/usr/bin/env node

/**
 * Module dependencies.
 */


exec = require('child_process').exec
program = require('commander');
mkdirp = require('mkdirp');
pkg = require('../package.json');
version = pkg.version;
os = require('os');
fs = require('fs');
npath = require('path');
grunt = require('grunt');
runner = require('karma').runner;
server = require('karma').server;
eol = 'win32' == os.platform() ? '\r\n' : '\n';
base_path = npath.join(npath.dirname(fs.realpathSync(__filename)), '../');
require('../lib/trig');
require('../lib/gruntConfig');
require('../lib/tasks');

grunt.initConfig(gruntConfig);

program
  .command('new <path>')
  .description('create a new trig app at the given path')
  .action(function(path){
    console.log("creating a new app!");
    trig.createApp(path);
  });

program
  .command('server')
  .description('run the trig app server')
  .action(function() {
    trig.runServer();
  });

program
  .command('test')
  .description('run the test suite')
  .action(function() {
    grunt.task.run(['env:development', 'stagecopy', 'karma:watch']);
    console.log('   \033[36mderiving tests\033[0m');
    grunt.task.start();
  });

program
  .command('clean')
  .description('clean up temporary files')
  .action(function() {
    grunt.task.run(['clean:stage']);
    console.log('   \033[36mtidying up!\033[0m');
    grunt.task.start();
  });

program

program
  .command('build')
  .description('create a production version of the app')
  .action(function() {
    grunt.task.run(['env:production', 'stagecopy', 'copy:production', 'concat', 'ngmin:app', 'uglify', 'cssmin', 'clean:production']);
    console.log('   \033[36mtriangulating a production build\033[0m');
    grunt.task.start();
  });

program
  .version(version)
  .option('-f, --force', 'force on non-empty directory')
  .option('--css', 'use boring old vanilla css (defaults to stylus)')
  .option('-p, --port', 'specify which port to run the server on')
  .parse(process.argv);

process.on( 'SIGINT', function() {
  console.log( "\ntidying up and closing down shop" )
  exec('rm -rf .stage');
  process.exit();
});








